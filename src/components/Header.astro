---
import TopHeader from "./TopHeader.astro"
import menu from "../data/menu.json"
---
<TopHeader />
<header class="site-header">

<nav class="main-nav" role="navigation" aria-label="Main navigation">
    <div class="nav-inner container">
        <div class="brand">
            <a href="/" aria-label="Best Patio Umbrella - Home">
                <h1 class="site-name">Best Patio Umbrella</h1>
            </a>
        </div>
        <button class="mobile-menu-toggle" aria-label="Toggle navigation menu" aria-expanded="false">
            <span class="hamburger-icon" aria-hidden="true"></span>
        </button>
        <div class="nav-list-wrapper">
            <ul class="nav-list" role="menubar">
                {menu.items.map(item => (
                    <li class="nav-item" role="none">
                        {item.columns ? (
                            <button class="nav-link" data-mega={item.id} aria-haspopup="true" aria-expanded="false" role="menuitem">{item.label}</button>
                        ) : (
                            <a class="nav-link" href={item.href ?? '#'} role="menuitem">{item.label}</a>
                        )}
                    </li>
                ))}
            </ul>
            <!-- Mega dropdown panels inside wrapper for mobile scroll -->
            {menu.items.filter(i => i.columns).map(item => (
                <div class="mega-panel" id={`megaPanel-${item.id}`} data-panel-for={item.id} aria-hidden="true">
                    <div class="mega-inner container">
                        <div class="mega-grid">
                            {(item.columns || []).map(col => (
                                <div class="mega-col">
                                    {col.title ? <h4 class="mega-title">{col.title}</h4> : null}
                                    <ul class="mega-list">
                                        {(col.links || []).map(link => (
                                            <li><a href={link.href}>{link.label}</a></li>
                                        ))}
                                    </ul>
                                    {col.extra ? (
                                        <>
                                            <h4 class="mega-title" style="margin-top:1rem">{col.extra.title}</h4>
                                            <ul class="mega-list">
                                                {(col.extra?.links || []).map(l => <li><a href={l.href}>{l.label}</a></li>)}
                                            </ul>
                                        </>
                                    ) : null}
                                    {col.image ? (
                                        <a href={col.image.href ?? '#'} class="mega-image-link">
                                            <img src={col.image.src} alt={col.image.alt} />
                                            {col.image.caption ? <div class="mega-image-caption">{col.image.caption}</div> : null}
                                        </a>
                                    ) : null}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            ))}
        </div>
    </div>
</nav>
<style>
.site-header{background:#fff}
/* Basic layout */
.main-nav{position:relative;border-bottom:1px solid rgba(0,0,0,0.06);background:#fff}
.nav-inner{display:flex;align-items:center;justify-content:space-between;padding:14px 18px}
.brand .site-name{font-size:20px;margin:0;color:#222}
.mobile-menu-toggle{display:none;background:none;border:0;padding:8px;cursor:pointer;z-index:1000}
.hamburger-icon{width:22px;height:2px;background:#333;display:block;position:relative;transition:background .3s}
.hamburger-icon::after,.hamburger-icon::before{content:"";position:absolute;left:0;width:22px;height:2px;background:#333;transition:transform .3s,top .3s}
.hamburger-icon::before{top:-7px}
.hamburger-icon::after{top:7px}
/* Hamburger animation */
.mobile-menu-toggle[aria-expanded="true"] .hamburger-icon{background:transparent}
.mobile-menu-toggle[aria-expanded="true"] .hamburger-icon::before{top:0;transform:rotate(45deg)}
.mobile-menu-toggle[aria-expanded="true"] .hamburger-icon::after{top:0;transform:rotate(-45deg)}
.nav-list-wrapper{display:contents}
.nav-list{display:flex;gap:24px;list-style:none;margin:0;padding:0}
.nav-link{background:none;border:0;padding:8px 6px;color:#444;font-weight:600;cursor:pointer;text-decoration:none}
/* Mega panel full width */
.mega-panel{position:absolute;left:0;right:0;top:100%;width:100%;z-index:60;pointer-events:none;opacity:0;transform-origin:top;transition:opacity .28s ease,transform .28s cubic-bezier(.2,.9,.3,1);background:#fff;box-shadow:0 12px 30px rgba(12,12,20,0.06)}
.mega-panel[aria-hidden="false"]{pointer-events:auto;opacity:1;transform:translateY(0)}
.mega-inner{padding:28px 18px}
.mega-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;align-items:start}
.mega-col{min-width:0}
.mega-title{font-size:13px;color:#333;margin:0 0 10px 0;font-weight:700}
.mega-list{list-style:none;padding:0;margin:0}
.mega-list li{margin:8px 0}
.mega-list a{color:#5b5460;text-decoration:none;font-size:15px}
.mega-image-col{display:flex;align-items:center;justify-content:center}
.mega-image-link{display:block;position:relative;border-radius:8px;overflow:hidden}
.mega-image-link img{width:100%;height:190px;object-fit:cover;display:block;transition:transform .45s cubic-bezier(.2,.9,.3,1)}
.mega-image-link:hover img{transform:scale(1.03)}
.mega-image-caption{position:absolute;left:12px;bottom:12px;color:#fff;font-weight:700;text-shadow:0 2px 8px rgba(0,0,0,0.45)}
/* Animations */
@keyframes panelShow{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
.mega-panel[aria-hidden="false"] .mega-inner{animation:panelShow .28s cubic-bezier(.2,.9,.3,1)}
/* Responsive */
@media (max-width:900px){
    .main-nav{position:relative}
    .nav-inner{padding:12px;position:relative;z-index:101}
    .mobile-menu-toggle{display:block}
    .nav-list-wrapper{display:none;position:fixed;top:60px;left:0;right:0;bottom:0;background:#fff;z-index:100;overflow-y:auto;-webkit-overflow-scrolling:touch}
    .nav-list-wrapper.mobile-open{display:block}
    .nav-list{display:flex;flex-direction:column;gap:0;margin:0;padding:0}
    .nav-item{width:100%;border-top:1px solid rgba(0,0,0,0.06)}
    .nav-link{display:block;width:100%;text-align:left;padding:14px 18px;font-size:16px}
    .mega-panel{position:static;opacity:1;pointer-events:auto;transform:none;box-shadow:none;background:rgba(0,0,0,0.02);display:none;border-top:1px solid rgba(0,0,0,0.06)}
    .mega-panel[aria-hidden="false"]{display:block}
    .mega-inner{padding:16px 18px}
    .mega-grid{grid-template-columns:1fr;gap:16px}
    .mega-title{font-size:14px;margin-bottom:8px}
    .mega-list li{margin:6px 0}
    .mega-list a{font-size:15px;display:block;padding:4px 0}
    .mega-image-link img{height:200px}
    /* Prevent body scroll when mobile menu is open */
    body.mobile-menu-open{overflow:hidden}
}
/* Add subtle backdrop on desktop when open */
@media (min-width:901px){
    .mega-panel::before{content:"";position:fixed;inset:0;background:rgba(15,15,20,0.04);backdrop-filter:blur(2px);z-index:-1}
}
</style>
<script type="module">
// Small client-side behaviour for mega menu and mobile toggle
const toggleBtn = document.querySelector('.mobile-menu-toggle');
const navListWrapper = document.querySelector('.nav-list-wrapper');
const megaTriggers = document.querySelectorAll('[data-mega]');

// Mobile menu toggle
if(toggleBtn && navListWrapper){
    toggleBtn.addEventListener('click', ()=>{
        const expanded = toggleBtn.getAttribute('aria-expanded') === 'true';
        toggleBtn.setAttribute('aria-expanded', String(!expanded));
        navListWrapper.classList.toggle('mobile-open');
        
        // Prevent body scroll when menu is open on mobile
        if(!expanded){
            document.body.classList.add('mobile-menu-open');
        } else {
            document.body.classList.remove('mobile-menu-open');
            closeAllPanels();
        }
    });
}

// Helper to close all panels
function closeAllPanels(){
    document.querySelectorAll('.mega-panel').forEach(p => p.setAttribute('aria-hidden','true'));
    document.querySelectorAll('[data-mega]').forEach(t => t.setAttribute('aria-expanded','false'));
}

// Detect if we're on mobile
function isMobile(){
    return window.innerWidth <= 900;
}

// Click outside to close (desktop only)
document.addEventListener('click', (e)=>{
    if(isMobile()) return;
    const inside = e.target.closest('.main-nav');
    if(!inside) closeAllPanels();
});

// Close on Escape
document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){
        closeAllPanels();
        if(isMobile() && navListWrapper?.classList.contains('mobile-open')){
            toggleBtn?.setAttribute('aria-expanded', 'false');
            navListWrapper.classList.remove('mobile-open');
            document.body.classList.remove('mobile-menu-open');
        }
    }
});

// Setup triggers for hover + click behaviour
megaTriggers.forEach(trigger => {
    const id = trigger.getAttribute('data-mega');
    const panel = document.getElementById(`megaPanel-${id}`);
    if(!panel) return;
    let hideTimeout;
    
    // Desktop hover (only on desktop)
    trigger.addEventListener('mouseenter', ()=>{
        if(isMobile()) return;
        closeAllPanels();
        panel.setAttribute('aria-hidden','false');
        trigger.setAttribute('aria-expanded','true');
        clearTimeout(hideTimeout);
    });
    
    trigger.addEventListener('mouseleave', ()=>{
        if(isMobile()) return;
        hideTimeout = setTimeout(()=>{
            panel.setAttribute('aria-hidden','true');
            trigger.setAttribute('aria-expanded','false');
        },220);
    });
    
    // Keep open when hovering the panel (desktop)
    panel.addEventListener('mouseenter', ()=>{
        if(isMobile()) return;
        clearTimeout(hideTimeout);
        panel.setAttribute('aria-hidden','false');
    });
    
    panel.addEventListener('mouseleave', ()=>{
        if(isMobile()) return;
        hideTimeout = setTimeout(()=>{
            panel.setAttribute('aria-hidden','true');
            trigger.setAttribute('aria-expanded','false');
        },220);
    });
    
    // Click to toggle
    trigger.addEventListener('click', (e)=>{
        e.preventDefault();
        const isOpen = panel.getAttribute('aria-hidden') === 'false';
        
        if(isMobile()){
            // Mobile: toggle current, close others
            closeAllPanels();
            if(!isOpen){
                panel.setAttribute('aria-hidden', 'false');
                trigger.setAttribute('aria-expanded', 'true');
            }
        } else {
            // Desktop: same behavior
            closeAllPanels();
            panel.setAttribute('aria-hidden', String(isOpen));
            trigger.setAttribute('aria-expanded', String(!isOpen));
        }
    });
});

// Close mobile menu on window resize to desktop
window.addEventListener('resize', ()=>{
    if(!isMobile() && navListWrapper?.classList.contains('mobile-open')){
        toggleBtn?.setAttribute('aria-expanded', 'false');
        navListWrapper.classList.remove('mobile-open');
        document.body.classList.remove('mobile-menu-open');
        closeAllPanels();
    }
});
</script>